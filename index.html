<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal & Admin Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        /* Custom styles for card borders */
        .card-border-blue { border-left: 5px solid #3b82f6; }
        .card-border-green { border-left: 5px solid #10b981; }
        .card-border-red { border-left: 5px solid #ef4444; }
        .card-border-orange { border-left: 5px solid #f97316; }

        /* Modal styling */
        .modal {
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 min-h-screen flex flex-col items-center">

    <div class="w-full max-w-5xl bg-white p-8 rounded-xl shadow-2xl mt-8">
        
        <header class="flex justify-between items-center pb-4 border-b border-gray-200">
            <h1 class="text-4xl font-extrabold text-indigo-700 tracking-tight">University Student Portal</h1>
            <button id="logoutBtn" onclick="logout()" class="hidden bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
                Logout
            </button>
        </header>

        <section id="login-section" class="mt-8">
            <div class="max-w-md mx-auto bg-gray-50 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">Login</h2>
                <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 mb-4 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500">
                <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 mb-6 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500">
                <button onclick="login()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-200">
                    Sign In
                </button>
                <div id="login-error" class="mt-4 text-center text-red-500 hidden font-medium"></div>
            </div>
        </section>

        <section id="admin-section" class="hidden mt-8">
            <h2 class="text-3xl font-bold mb-4 text-indigo-700">üèõÔ∏è Student Manager</h2>
            
            <div class="flex border-b border-gray-300 mb-6">
                <button onclick="showAdminPanel('dashboard-panel')" id="dashboard-tab" class="px-4 py-2 text-lg font-medium border-b-2 border-indigo-600 text-indigo-600 transition-colors duration-150">Dashboard</button>
                <button onclick="showAdminPanel('add-student-panel')" id="add-student-tab" class="px-4 py-2 text-lg font-medium text-gray-500 hover:text-indigo-600 transition-colors duration-150">Add/Edit Student Data</button>
                
                <button class="ml-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-200" onclick="showAdminPanel('add-student-panel')">
                    + Add New Student
                </button>
            </div>

            <div id="dashboard-panel" class="">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Student Details</h3>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    
                    <div class="bg-white p-4 rounded-lg shadow-md card-border-blue">
                        <p class="text-gray-500 font-medium">Total Students</p>
                        <p id="dashboard-total-students" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-md card-border-green">
                        <p class="text-gray-500 font-medium">Active Enrollment</p>
                        <p id="dashboard-active-enrollment" class="text-3xl font-bold text-green-600 mt-1">0</p>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-md card-border-red">
                        <p class="text-gray-500 font-medium">Inactive/Dropout</p>
                        <p id="dashboard-inactive-dropout" class="text-3xl font-bold text-red-600 mt-1">0</p>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-md card-border-orange">
                        <p class="text-gray-500 font-medium">Pending Actions</p>
                        <p id="dashboard-pending-actions" class="text-3xl font-bold text-orange-600 mt-1">4</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-xl">
                    <input type="text" 
                        id="search-input" 
                        placeholder="Search by name, ID, or grade..." 
                        oninput="searchStudents()"
                        class="w-full p-3 mb-6 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500">
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NAME</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STUDENT ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">GRADE</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EMAIL</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STATUS</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-6 py-8 text-center text-lg text-gray-500">
                                        Loading student data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="add-student-panel" class="hidden">
                <h3 class="text-xl font-semibold mb-4 text-gray-700"><span id="form-title">Add Student Data Form</span></h3>
                <div class="bg-white p-6 rounded-lg shadow-xl">
                    <form id="addStudentForm" class="space-y-4">
                        <input type="hidden" id="originalEmail" value="">
                        <input type="text" id="sID" placeholder="Student ID (e.g., S2023001)" class="w-full p-3 border rounded" required>
                        <input type="email" id="sEmail" placeholder="Email (for login/contact)" class="w-full p-3 border rounded" required>
                        <input type="password" id="sPassword" placeholder="Temporary Password (required for new student)" class="w-full p-3 border rounded">
                        <input type="text" id="sName" placeholder="Student Name" class="w-full p-3 border rounded" required>
                        <input type="text" id="sDept" placeholder="Department Name" class="w-full p-3 border rounded" required>
                        <input type="number" step="0.01" id="sCGPA" placeholder="Current CGPA" class="w-full p-3 border rounded" required>
                        
                        <label for="sStatus" class="block text-sm font-medium text-gray-700 pt-2">Student Status</label>
                        <select id="sStatus" class="w-full p-3 border rounded bg-white">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                            <option value="Dropout">Dropout</option>
                        </select>

                        <h3 class="text-xl font-semibold mt-6 mb-2">Course Results</h3>
                        <div id="results-container" class="space-y-2">
                            <div class="flex space-x-2 result-entry">
                                <input type="text" placeholder="Course Name (e.g., CS101)" class="w-2/5 p-2 border rounded" required>
                                <input type="text" placeholder="Grade (e.g., A+)" class="w-1/5 p-2 border rounded" required>
                                <input type="number" placeholder="Marks (e.g., 85)" class="w-1/5 p-2 border rounded" required>
                                <button type="button" class="w-1/5 bg-red-400 text-white rounded" onclick="this.parentNode.remove()">Remove</button>
                            </div>
                        </div>
                        <button type="button" onclick="addResultField()" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded">Add Course</button>
                        
                        <h3 class="text-xl font-semibold mt-6 mb-2">Routine/Courses</h3>
                        <textarea id="sRoutine" placeholder="Routine & Course List (text area for display on student side)" class="w-full p-3 border rounded h-32"></textarea>

                        <button type="submit" id="submit-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded mt-6">Add/Update Student</button>
                        <button type="button" onclick="resetForm()" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 rounded mt-2">Reset Form / Add New</button>
                        <div id="admin-message" class="mt-4 text-center text-green-600 hidden flex flex-col items-center p-4 border rounded-lg bg-green-50">
                            <!-- Success message and links will be injected here -->
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <section id="student-section" class="hidden mt-8">
            <h2 class="text-3xl font-bold mb-6 text-indigo-700 border-b pb-2">Welcome, <span id="student-name">Student</span>!</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <p class="text-gray-500 font-medium">Department</p>
                    <p id="s-dept" class="text-2xl font-bold text-gray-900 mt-1">N/A</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <p class="text-gray-500 font-medium">Current CGPA</p>
                    <p id="s-cgpa" class="text-2xl font-bold text-green-600 mt-1">N/A</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <p class="text-gray-500 font-medium">Total Credits</p>
                    <p id="s-credits" class="text-2xl font-bold text-indigo-600 mt-1">0</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-xl mb-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Weekly Routine & Courses</h3>
                <pre id="s-routine" class="whitespace-pre-wrap text-gray-700 bg-gray-50 p-4 rounded"></pre>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-xl">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Academic Results</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course Code</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Marks</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

    </div>

    <div id="delete-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center opacity-0 pointer-events-none z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full transform transition-all duration-300">
            <h3 class="text-xl font-bold text-red-600 mb-4">Confirm Deletion</h3>
            <p id="modal-text" class="text-gray-700 mb-6">Are you sure you want to delete this student's record?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded">
                    Cancel
                </button>
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <script>
        // üö® STEP 1: REPLACE WITH YOUR ACTUAL FIREBASE CONFIG üö®
        const firebaseConfig = {
            apiKey: "AIzaSyCNgK0n2OxTggtZcu0hraTWhMhtLW0oxmc", // <--- REPLACE THIS
            authDomain: "studentinfo-fd67b.firebaseapp.com", // <--- REPLACE THIS
            projectId: "studentinfo-fd67b", // <--- REPLACE THIS
            storageBucket: "studentinfo-fd67b.firebasestorage.app", // <--- REPLACE THIS
            messagingSenderId: "1023011026315", // <--- REPLACE THIS
            appId: "1:1023011026315:web:455120a62b7a3c80e86b8e" // <--- REPLACE THIS
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const ADMIN_EMAIL = 'admin@university.edu'; // üö® MUST MATCH THE ADMIN USER YOU CREATED IN FIREBASE üö®

        // Variable to store the full list of student documents for client-side searching
        let allStudentDocs = []; 

        // --- COMMON UTILITY FUNCTIONS ---

        function showSection(id) {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('student-section').classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            
            if (id) {
                document.getElementById(id).classList.remove('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');

                if (id === 'admin-section') {
                    // Set default admin panel view
                    showAdminPanel('dashboard-panel');
                }
            }
        }
        
        function showAdminPanel(panelId) {
            const dashboardPanel = document.getElementById('dashboard-panel');
            const addStudentPanel = document.getElementById('add-student-panel');
            const dashboardTab = document.getElementById('dashboard-tab');
            const addStudentTab = document.getElementById('add-student-tab');
            
            dashboardPanel.classList.add('hidden');
            addStudentPanel.classList.add('hidden');
            
            // Reset tab styles
            [dashboardTab, addStudentTab].forEach(tab => {
                tab.classList.remove('border-indigo-600', 'text-indigo-600', 'border-b-2');
                tab.classList.add('text-gray-500', 'hover:text-indigo-600');
            });

            // Set active panel and tab style
            if (panelId === 'dashboard-panel') {
                dashboardPanel.classList.remove('hidden');
                dashboardTab.classList.add('border-indigo-600', 'text-indigo-600', 'border-b-2');
                dashboardTab.classList.remove('text-gray-500', 'hover:text-indigo-600');
                fetchDashboardCounts(); 
            } else if (panelId === 'add-student-panel') {
                addStudentPanel.classList.remove('hidden');
                addStudentTab.classList.add('border-indigo-600', 'text-indigo-600', 'border-b-2');
                addStudentTab.classList.remove('text-gray-500', 'hover:text-indigo-600');
                
                // When navigating back to the form, hide the success message
                document.getElementById('admin-message').classList.add('hidden');
            }
        }

        function resetForm() {
            document.getElementById('addStudentForm').reset();
            document.getElementById('originalEmail').value = '';
            document.getElementById('sEmail').readOnly = false;
            document.getElementById('sPassword').required = true;
            document.getElementById('sPassword').placeholder = "Temporary Password (required for new student)"; // Reset placeholder
            document.getElementById('form-title').textContent = 'Add Student Data Form';
            document.getElementById('submit-button').textContent = 'Add Student';
            document.getElementById('admin-message').classList.add('hidden');
            
            // Re-populate with a single empty result field
            document.getElementById('results-container').innerHTML = `
                <div class="flex space-x-2 result-entry">
                    <input type="text" placeholder="Course Name (e.g., CS101)" class="w-2/5 p-2 border rounded" required>
                    <input type="text" placeholder="Grade (e.g., A+)" class="w-1/5 p-2 border rounded" required>
                    <input type="number" placeholder="Marks (e.g., 85)" class="w-1/5 p-2 border rounded" required>
                    <button type="button" class="w-1/5 bg-red-400 text-white rounded" onclick="this.parentNode.remove()">Remove</button>
                </div>`;
        }

        // --- AUTHENTICATION LOGIC ---
        
        auth.onAuthStateChanged(user => {
            if (user) {
                if (user.email === ADMIN_EMAIL) {
                    showSection('admin-section');
                } else {
                    fetchStudentData(user.email); 
                }
            } else {
                showSection('login-section');
            }
        });

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('login-error');
            errorDiv.classList.add('hidden');

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                errorDiv.textContent = 'Login failed: ' + error.message;
                errorDiv.classList.remove('hidden');
                console.error("Login Error:", error);
            }
        }

        function logout() {
            auth.signOut();
        }

        // --- DASHBOARD AND SEARCH LOGIC ---
        
        async function fetchDashboardCounts() {
            try {
                const snapshot = await db.collection("students").get();
                
                allStudentDocs = snapshot.docs;
                
                const totalStudents = allStudentDocs.length;
                let activeEnrollment = 0;
                let inactiveDropout = 0;
                
                allStudentDocs.forEach(doc => {
                    const studentData = doc.data();
                    const status = studentData.status || 'Active';
                    
                    if (status === 'Inactive' || status === 'Dropout') {
                         inactiveDropout++;
                    } else {
                        activeEnrollment++;
                    }
                });
                
                document.getElementById('dashboard-total-students').textContent = totalStudents;
                document.getElementById('dashboard-active-enrollment').textContent = activeEnrollment;
                document.getElementById('dashboard-inactive-dropout').textContent = inactiveDropout;
                document.getElementById('dashboard-pending-actions').textContent = '4';
                
                populateStudentListTable(allStudentDocs);

            } catch (error) {
                console.error("Error fetching dashboard counts. Check Firebase Rules:", error);
                document.getElementById('student-list-body').innerHTML = `
                    <tr><td colspan="6" class="px-6 py-8 text-center text-red-500">Error loading data. Check console for details.</td></tr>
                `;
            }
        }

        function searchStudents() {
            const query = document.getElementById('search-input').value.toLowerCase().trim();
            
            if (query === "") {
                populateStudentListTable(allStudentDocs);
                return;
            }

            const filteredDocs = allStudentDocs.filter(doc => {
                const data = doc.data();
                const searchTerms = [
                    data.name, 
                    data.studentId, 
                    data.email, 
                    data.department,
                    data.cgpa ? data.cgpa.toString() : ''
                ].join(' ').toLowerCase();

                return searchTerms.includes(query);
            });

            populateStudentListTable(filteredDocs);
        }

        // UPDATED: Added click handlers for Edit and Delete
        function populateStudentListTable(studentDocs) {
            const tableBody = document.getElementById('student-list-body');
            tableBody.innerHTML = ''; 

            if (studentDocs.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-lg text-gray-500">
                            No students found.
                        </td>
                    </tr>
                `;
                return;
            }

            studentDocs.forEach(doc => {
                const data = doc.data();
                const studentEmail = doc.id; // Document ID is the email
                const statusText = data.status || 'Active';
                const statusClass = statusText === 'Inactive' || statusText === 'Dropout' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
                
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${data.name || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.studentId || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.cgpa ? data.cgpa.toFixed(2) : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.email || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editStudent('${studentEmail}')" class="text-indigo-600 hover:text-indigo-900 font-semibold mr-2">Edit</button>
                            <button onclick="showDeleteModal('${studentEmail}', '${data.name}')" class="text-red-600 hover:text-red-900 font-semibold">Delete</button>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }
        
        // --- EDIT, DELETE, AND FORM LOGIC ---

        async function editStudent(email) {
            try {
                const docRef = db.collection("students").doc(email);
                const doc = await docRef.get();

                if (doc.exists) {
                    const data = doc.data();
                    
                    // Switch to the Add/Edit panel
                    showAdminPanel('add-student-panel');
                    document.getElementById('admin-message').classList.add('hidden'); // Ensure message is hidden on edit start

                    // Set form state for editing
                    document.getElementById('originalEmail').value = email;
                    document.getElementById('sEmail').value = email;
                    document.getElementById('sEmail').readOnly = true; // Prevent changing email (Doc ID) during edit
                    document.getElementById('sPassword').required = false; // Password is not required for update
                    document.getElementById('sPassword').value = ''; // Clear password field for security
                    document.getElementById('sPassword').placeholder = 'Enter new password to change (leave blank for no change)';
                    document.getElementById('form-title').textContent = 'Edit Student Data';
                    document.getElementById('submit-button').textContent = 'Update Student';
                    

                    // Populate form fields
                    document.getElementById('sID').value = data.studentId || '';
                    document.getElementById('sName').value = data.name || '';
                    document.getElementById('sDept').value = data.department || '';
                    document.getElementById('sCGPA').value = data.cgpa || '';
                    document.getElementById('sRoutine').value = data.routine || '';
                    document.getElementById('sStatus').value = data.status || 'Active';

                    // Populate results
                    const container = document.getElementById('results-container');
                    container.innerHTML = '';
                    
                    if (data.results && data.results.length > 0) {
                        data.results.forEach(result => {
                            const html = `
                                <div class="flex space-x-2 result-entry">
                                    <input type="text" value="${result.course || ''}" placeholder="Course Name (e.g., CS101)" class="w-2/5 p-2 border rounded" required>
                                    <input type="text" value="${result.grade || ''}" placeholder="Grade (e.g., A+)" class="w-1/5 p-2 border rounded" required>
                                    <input type="number" value="${result.marks || ''}" placeholder="Marks (e.g., 85)" class="w-1/5 p-2 border rounded" required>
                                    <button type="button" class="w-1/5 bg-red-400 text-white rounded" onclick="this.parentNode.remove()">Remove</button>
                                </div>
                            `;
                            container.insertAdjacentHTML('beforeend', html);
                        });
                    } else {
                           // Add a default empty entry if no results exist
                         addResultField();
                    }

                } else {
                    console.error("Student data not found for edit:", email);
                }
            } catch (error) {
                console.error("Error fetching student data for edit:", error);
            }
        }


        function showDeleteModal(email, name) {
            const modal = document.getElementById('delete-modal');
            const modalText = document.getElementById('modal-text');
            const confirmBtn = document.getElementById('confirm-delete-btn');

            modalText.textContent = `Are you sure you want to permanently delete the record for ${name} (${email})?`;
            confirmBtn.onclick = () => deleteStudent(email);

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
        }

        function closeModal() {
            const modal = document.getElementById('delete-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        }

        async function deleteStudent(email) {
            closeModal(); 
            const messageDiv = document.getElementById('admin-message');

            try {
                await db.collection("students").doc(email).delete();
                
                messageDiv.textContent = `Student ${email} successfully deleted.`;
                messageDiv.classList.remove('hidden', 'text-red-600');
                messageDiv.classList.add('text-green-600');
                
                // Refresh the dashboard list
                fetchDashboardCounts(); 

            } catch (error) {
                messageDiv.textContent = 'Error deleting data: ' + error.message;
                messageDiv.classList.remove('hidden', 'text-green-600');
                messageDiv.classList.add('text-red-600');
                console.error("Delete Error:", error);
            }
        }


        function addResultField() {
            const container = document.getElementById('results-container');
            const html = `
                <div class="flex space-x-2 result-entry">
                    <input type="text" placeholder="Course Name (e.g., CS101)" class="w-2/5 p-2 border rounded" required>
                    <input type="text" placeholder="Grade (e.g., A+)" class="w-1/5 p-2 border rounded" required>
                    <input type="number" placeholder="Marks (e.g., 85)" class="w-1/5 p-2 border rounded" required>
                    <button type="button" class="w-1/5 bg-red-400 text-white rounded" onclick="this.parentNode.remove()">Remove</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const sID = document.getElementById('sID').value.trim();
            const sEmail = document.getElementById('sEmail').value.trim();
            const sPassword = document.getElementById('sPassword').value;
            const sName = document.getElementById('sName').value.trim();
            const sDept = document.getElementById('sDept').value.trim();
            const sCGPA = parseFloat(document.getElementById('sCGPA').value);
            const sRoutine = document.getElementById('sRoutine').value.trim();
            const sStatus = document.getElementById('sStatus').value;
            const originalEmail = document.getElementById('originalEmail').value.trim(); // Only set when editing

            const messageDiv = document.getElementById('admin-message');
            messageDiv.classList.add('hidden');
            messageDiv.classList.remove('text-red-600', 'text-green-600', 'border-red-200');
            messageDiv.classList.add('border-green-200'); // Default success style
            messageDiv.innerHTML = ''; // Clear previous messages/buttons

            // 1. Collect Course Results
            const results = [];
            const resultEntries = document.querySelectorAll('#results-container .result-entry');
            resultEntries.forEach(entry => {
                const inputs = entry.querySelectorAll('input');
                if (inputs[0].value.trim() && inputs[1].value.trim() && inputs[2].value.trim()) {
                    results.push({
                        course: inputs[0].value.trim(),
                        grade: inputs[1].value.trim(),
                        marks: parseInt(inputs[2].value)
                    });
                }
            });

            // Student Data object to save in Firestore
            const studentData = {
                studentId: sID,
                email: sEmail,
                name: sName,
                department: sDept,
                cgpa: sCGPA,
                routine: sRoutine,
                status: sStatus,
                results: results,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            const isEditing = originalEmail !== '';

            try {
                // --- ADMIN AUTH (USER CREATION/UPDATE) ---

                if (!isEditing) {
                    // **A. Creating a new user via Firebase Auth**
                    if (!sPassword) {
                        throw new Error("Temporary password is required when adding a new student.");
                    }
                    await auth.createUserWithEmailAndPassword(sEmail, sPassword);
                    messageDiv.innerHTML = `<span class="text-lg font-semibold text-green-700">‚úÖ Student ${sName} added successfully!</span>`;
                } else {
                    // **B. Handling user update:**
                    messageDiv.innerHTML = `<span class="text-lg font-semibold text-green-700">‚úÖ Student ${sName} successfully updated.</span>`;
                }

                // --- FIRESTORE DATA STORAGE ---
                
                // Use the student's email as the document ID for easy lookup.
                await db.collection("students").doc(sEmail).set(studentData, { merge: true });

                
                messageDiv.classList.remove('hidden', 'text-red-600', 'border-red-200');
                messageDiv.classList.add('text-green-600', 'border-green-200');
                
                // --- POST-SUCCESS NAVIGATION/ACTION ---
                
                // Add action buttons
                messageDiv.innerHTML += `
                    <div class="flex flex-col space-y-2 mt-4 w-full max-w-sm">
                        <button type="button" onclick="showAdminPanel('dashboard-panel')" 
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded transition duration-200 shadow-md">
                            Go to Dashboard (View All Students)
                        </button>
                        <button type="button" onclick="resetForm()" 
                                class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded transition duration-200 shadow-md">
                            Add Another Student (Stay Here)
                        </button>
                    </div>
                `;

                // Clear the form fields but keep the user on the add-student panel
                resetForm(); 

                // Ensure Dashboard list is updated in background
                fetchDashboardCounts(); 

            } catch (error) {
                // Handle Firebase Auth errors (e.g., email already in use, weak password) 
                let errorMessage = error.message;

                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email is already registered. Use a unique email or edit the existing record.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password must be at least 6 characters.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address format.';
                } else if (error.message.includes("Temporary password is required")) {
                    errorMessage = error.message;
                }
                
                messageDiv.textContent = `Operation Failed: ${errorMessage}`;
                messageDiv.classList.remove('hidden', 'text-green-600', 'border-green-200');
                messageDiv.classList.add('text-red-600', 'border-red-200');
                console.error("Form Submission Error:", error);
            }
        });

        // --- STUDENT VIEW LOGIC ---

        async function fetchStudentData(email) {
            try {
                const docRef = db.collection("students").doc(email);
                const doc = await docRef.get();

                if (doc.exists) {
                    const data = doc.data();
                    showSection('student-section');

                    document.getElementById('student-name').textContent = data.name || 'Student';
                    document.getElementById('s-dept').textContent = data.department || 'N/A';
                    document.getElementById('s-cgpa').textContent = data.cgpa ? data.cgpa.toFixed(2) : 'N/A';
                    document.getElementById('s-routine').textContent = data.routine || 'No routine information available.';
                    
                    // Populate results table
                    const tableBody = document.getElementById('results-table-body');
                    tableBody.innerHTML = '';
                    let totalCredits = 0;

                    if (data.results && data.results.length > 0) {
                        data.results.forEach(result => {
                            const row = `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${result.course || 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.grade || 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.marks || 'N/A'}</td>
                                </tr>
                            `;
                            tableBody.insertAdjacentHTML('beforeend', row);
                            totalCredits += 3;
                        });
                        document.getElementById('s-credits').textContent = totalCredits;
                    } else {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="3" class="px-6 py-4 text-center text-gray-500">No academic results found.</td>
                            </tr>
                        `;
                    }


                } else {
                    // Student user is logged in but no data in Firestore
                    showSection('student-section');
                    document.getElementById('student-name').textContent = "User";
                    document.getElementById('s-dept').textContent = "Record Missing";
                    document.getElementById('s-cgpa').textContent = "N/A";
                    document.getElementById('s-routine').textContent = "Your administrative record could not be found. Please contact the admin.";
                    document.getElementById('results-table-body').innerHTML = `
                        <tr><td colspan="3" class="px-6 py-4 text-center text-red-500">Record Missing</td></tr>
                    `;
                }

            } catch (error) {
                console.error("Error fetching student data:", error);
                document.getElementById('student-name').textContent = "Error";
                document.getElementById('s-dept').textContent = "Error";
                document.getElementById('s-cgpa').textContent = "Error";
                document.getElementById('s-routine').textContent = "An error occurred while loading your data.";
            }
        }
        
        // --- ENHANCED FUNCTIONALITY: Student ID auto-populates Password field (ONLY for New Students) ---
        document.addEventListener('DOMContentLoaded', () => {
             const sIDInput = document.getElementById('sID');
             const sPasswordInput = document.getElementById('sPassword');
             const originalEmailInput = document.getElementById('originalEmail');
             
             const updatePassword = () => {
                 // Check if we are in 'Add New' mode (originalEmail is empty) and the password field is required
                 const isNewStudentMode = originalEmailInput.value === '';
                 
                 // Also ensure the password field is editable (not readonly/disabled)
                 if (isNewStudentMode) {
                     // Set the password to the Student ID
                     sPasswordInput.value = sIDInput.value.trim();
                 }
             };

             // 1. Listen for input changes on the Student ID field
             sIDInput.addEventListener('input', updatePassword);
             
             // 2. We can override the resetForm function to explicitly apply the logic after a reset
             // This ensures if the browser autofills the ID, the password is set too.
             const originalResetForm = window.resetForm;
             window.resetForm = function() {
                 originalResetForm.apply(this, arguments);
                 // Check if the sID already has a value (e.g., from a browser cache fill), set the password immediately
                 if (sIDInput.value.trim() !== '') {
                     updatePassword();
                 }
             };
        });
        // --- END ENHANCED FUNCTIONALITY ---

    </script>
</body>
</html>