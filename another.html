<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        /* Simple style to hide/show sections */
        .hidden { display: none; }
        /* Active Admin Tab Style */
        .admin-tab.active {
            border-bottom: 3px solid #f97316; /* Tailwind orange-500 */
            color: #f97316; /* Tailwind orange-500 */
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center">

    <header class="w-full bg-indigo-600 p-4 text-white shadow-md flex justify-between items-center">
        <h1 class="text-2xl font-bold">University Portal</h1>
        <button id="logoutBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded hidden" onclick="logout()">Logout</button>
    </header>

    <main class="w-full max-w-4xl p-6">

        <section id="login-section" class="bg-white p-6 rounded-lg shadow-xl mt-10 w-full max-w-md mx-auto">
            <h2 class="text-2xl font-semibold mb-6 text-center text-indigo-700">Login</h2>
            <div id="login-error" class="text-red-500 mb-4 hidden"></div>
            <input type="email" id="loginEmail" placeholder="Email or Student ID (Admin: admin@...)" class="w-full p-3 mb-4 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500" required>
            <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 mb-6 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500" required>
            <button onclick="login()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded transition duration-200">Sign In</button>
        </section>

        <section id="admin-section" class="hidden mt-8">
            <h2 class="text-3xl font-bold mb-4 text-indigo-700">üèõÔ∏è Admin Dashboard</h2>
            
            <nav class="flex border-b border-gray-300 mb-6 bg-white rounded-t-lg shadow-md">
                <button id="tab-list" class="admin-tab p-4 text-lg text-gray-600 hover:text-orange-500 transition duration-150 active" onclick="showAdminTab('admin-list-tab')">Student Details</button>
                <button id="tab-add" class="admin-tab p-4 text-lg text-gray-600 hover:text-orange-500 transition duration-150" onclick="showAdminTab('admin-add-tab')">Add/Edit Student</button>
            </nav>

            <div id="admin-list-tab">
                <div class="grid grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow-xl text-center">
                        <p class="text-xl font-bold text-gray-800">Total Students</p>
                        <p id="stat-total" class="text-3xl font-extrabold text-blue-600 mt-1">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-xl text-center">
                        <p class="text-xl font-bold text-gray-800">Active Enrollment</p>
                        <p id="stat-active" class="text-3xl font-extrabold text-green-600 mt-1">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-xl text-center">
                        <p class="text-xl font-bold text-gray-800">Inactive/Dropout</p>
                        <p id="stat-inactive" class="text-3xl font-extrabold text-red-600 mt-1">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-xl text-center">
                        <p class="text-xl font-bold text-gray-800">Pending Actions</p>
                        <p id="stat-pending" class="text-3xl font-extrabold text-yellow-600 mt-1">4</p>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-6">
                    <input type="text" id="student-search" onkeyup="filterStudentList()" placeholder="Search by name, ID, or grade..." class="w-3/5 p-3 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500">
                    <button onclick="showAdminTab('admin-add-tab')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Add New Student
                    </button>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-xl overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <th class="px-3 py-3">Name</th>
                                <th class="px-3 py-3">Student ID</th>
                                <th class="px-3 py-3">Grade/CGPA</th>
                                <th class="px-3 py-3">Email</th>
                                <th class="px-3 py-3">Status</th>
                                <th class="px-3 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="student-list-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="6" class="text-center py-8 text-gray-500 font-semibold">No students found. Add your first student to the system!</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="admin-add-tab" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow-xl">
                    <form id="addStudentForm" class="space-y-4">
                        <h3 class="text-2xl font-semibold mb-4 text-indigo-700">Add New Student Record</h3>
                        <input type="text" id="sID" placeholder="Student ID (e.g., S2023001)" class="w-full p-3 border rounded" required>
                        <input type="email" id="sEmail" placeholder="Email (for login/contact)" class="w-full p-3 border rounded" required>
                        <input type="password" id="sPassword" placeholder="Temporary Password (for student login)" class="w-full p-3 border rounded" required>
                        <input type="text" id="sName" placeholder="Student Name" class="w-full p-3 border rounded" required>
                        <input type="text" id="sDept" placeholder="Department Name" class="w-full p-3 border rounded" required>
                        <input type="number" step="0.01" id="sCGPA" placeholder="Current CGPA" class="w-full p-3 border rounded" required>

                        <h3 class="text-xl font-semibold mt-6 mb-2">Course Results</h3>
                        <div id="results-container" class="space-y-2">
                            <div class="flex space-x-2 result-entry">
                                <input type="text" placeholder="Course Name (e.g., CS101)" class="w-2/5 p-2 border rounded" required>
                                <input type="text" placeholder="Grade (e.g., A+)" class="w-1/5 p-2 border rounded" required>
                                <input type="number" placeholder="Marks (e.g., 85)" class="w-1/5 p-2 border rounded" required>
                                <button type="button" class="w-1/5 bg-red-400 text-white rounded" onclick="this.parentNode.remove()">Remove</button>
                            </div>
                        </div>
                        <button type="button" onclick="addResultField()" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded">Add Course</button>
                        
                        <h3 class="text-xl font-semibold mt-6 mb-2">Routine/Courses</h3>
                        <textarea id="sRoutine" placeholder="Routine & Course List (text area for display on student side)" class="w-full p-3 border rounded h-32"></textarea>

                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded mt-6">Add/Update Student</button>
                        <div id="admin-message" class="mt-4 text-center text-green-600 hidden"></div>
                    </form>
                </div>
            </div>
        </section>

        <section id="student-section" class="hidden mt-8">
            <h2 class="text-3xl font-bold mb-6 text-indigo-700">üßë‚Äçüéì Welcome, <span id="student-name" class="text-orange-500"></span>!</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <p class="text-lg text-gray-500">Department</p>
                    <p id="s-dept" class="text-2xl font-semibold text-indigo-600">-</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <p class="text-lg text-gray-500">CGPA</p>
                    <p id="s-cgpa" class="text-3xl font-bold text-green-600">-</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <p class="text-lg text-gray-500">Total Credits</p>
                    <p id="s-credits" class="text-2xl font-semibold text-indigo-600">-</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-xl mb-8">
                <h3 class="text-2xl font-semibold mb-4 text-indigo-700">Course Results</h3>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Marks</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-xl">
                <h3 class="text-2xl font-semibold mb-4 text-indigo-700">Routine & Course List</h3>
                <p id="s-routine" class="whitespace-pre-wrap text-gray-700"></p>
            </div>
        </section>
        
    </main>

    <script>
        // üö® STEP 1: REPLACE WITH YOUR ACTUAL FIREBASE CONFIG üö®
        const firebaseConfig = {
            apiKey: "AIzaSyCNgK0n2OxTggtZcu0hraTWhMhtLW0oxmc", // <--- REPLACE THIS
            authDomain: "studentinfo-fd67b.firebaseapp.com", // <--- REPLACE THIS
            projectId: "studentinfo-fd67b", // <--- REPLACE THIS
            storageBucket: "studentinfo-fd67b.firebasestorage.app", // <--- REPLACE THIS
            messagingSenderId: "1023011026315", // <--- REPLACE THIS
            appId: "1:1023011026315:web:455120a62b7a3c80e86b8e" // <--- REPLACE THIS
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const ADMIN_EMAIL = 'admin@university.edu'; // üö® MUST MATCH THE ADMIN USER YOU CREATED IN STEP 1 üö®

        let allStudentsData = []; // Global array to store fetched student data for list/search

        // --- COMMON UTILITY FUNCTIONS ---

        function showSection(id) {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('student-section').classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            
            if (id) {
                document.getElementById(id).classList.remove('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
            }
        }

        function showAdminTab(tabId) {
            // Hide all admin tab content
            document.getElementById('admin-list-tab').classList.add('hidden');
            document.getElementById('admin-add-tab').classList.add('hidden');

            // Deactivate all tab buttons
            document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));

            // Show the selected tab content
            document.getElementById(tabId).classList.remove('hidden');

            // Activate the corresponding tab button
            if (tabId === 'admin-list-tab') {
                document.getElementById('tab-list').classList.add('active');
                fetchAllStudents(); // Fetch and display the list when switching to the list view
            } else if (tabId === 'admin-add-tab') {
                document.getElementById('tab-add').classList.add('active');
            }
        }

        // --- AUTHENTICATION LOGIC ---
        
        // Listen for Auth State Changes
        auth.onAuthStateChanged(user => {
            if (user) {
                if (user.email === ADMIN_EMAIL) {
                    showSection('admin-section');
                    showAdminTab('admin-list-tab'); // Show the new list view by default
                } else {
                    fetchStudentData(user.email); 
                }
            } else {
                showSection('login-section');
            }
        });

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('login-error');
            errorDiv.classList.add('hidden');

            try {
                await auth.signInWithEmailAndPassword(email, password);
                // Auth state listener handles the section display
            } catch (error) {
                errorDiv.textContent = 'Login failed: ' + error.message;
                errorDiv.classList.remove('hidden');
                console.error("Login Error:", error);
            }
        }

        function logout() {
            auth.signOut();
        }

        // --- ADMIN PANEL LOGIC ---

        // NEW FUNCTION: Fetch all students for the list view
        async function fetchAllStudents() {
            try {
                const snapshot = await db.collection("students").get();
                allStudentsData = snapshot.docs.map(doc => doc.data());
                
                // Update Stats
                document.getElementById('stat-total').textContent = allStudentsData.length;
                document.getElementById('stat-active').textContent = allStudentsData.length; // Simple for this example
                document.getElementById('stat-inactive').textContent = 0; // Simple for this example

                // Display the list
                renderStudentList(allStudentsData);
            } catch (error) {
                console.error("Error fetching all students:", error);
                const tableBody = document.getElementById('student-list-body');
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Error loading student data.</td></tr>`;
            }
        }

        // NEW FUNCTION: Render the student list table
        function renderStudentList(students) {
            const tableBody = document.getElementById('student-list-body');
            tableBody.innerHTML = ''; 

            if (students.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500 font-semibold">No students found. Add your first student to the system!</td></tr>`;
                return;
            }

            students.forEach(student => {
                const row = tableBody.insertRow();
                const studentStatus = 'Active'; // Simple status for this example
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-700">${student.studentId}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-green-600 font-bold">${student.cgpa.toFixed(2)}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${student.email}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">${studentStatus}</span></td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="alert('Edit functionality not fully implemented.')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                        <button onclick="alert('Delete functionality not fully implemented.')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `;
            });
        }

        // NEW FUNCTION: Filter student list based on search input
        function filterStudentList() {
            const query = document.getElementById('student-search').value.toLowerCase();
            const filteredStudents = allStudentsData.filter(student => 
                student.name.toLowerCase().includes(query) ||
                student.studentId.toLowerCase().includes(query) ||
                student.cgpa.toString().includes(query) 
            );
            renderStudentList(filteredStudents);
        }

        // Function to add a new result row in the admin form (Original logic)
        function addResultField() {
            const container = document.getElementById('results-container');
            const html = `
                <div class="flex space-x-2 result-entry">
                    <input type="text" placeholder="Course Name (e.g., CS101)" class="w-2/5 p-2 border rounded" required>
                    <input type="text" placeholder="Grade (e.g., A+)" class="w-1/5 p-2 border rounded" required>
                    <input type="number" placeholder="Marks (e.g., 85)" class="w-1/5 p-2 border rounded" required>
                    <button type="button" class="w-1/5 bg-red-400 text-white rounded" onclick="this.parentNode.remove()">Remove</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const sID = document.getElementById('sID').value.trim();
            const sEmail = document.getElementById('sEmail').value.trim();
            const sPassword = document.getElementById('sPassword').value;
            const sName = document.getElementById('sName').value;
            const sDept = document.getElementById('sDept').value;
            const sCGPA = parseFloat(document.getElementById('sCGPA').value);
            const sRoutine = document.getElementById('sRoutine').value;
            const messageDiv = document.getElementById('admin-message');
            
            // 1. Gather Course Results
            const results = [];
            const entries = document.querySelectorAll('#admin-add-tab .result-entry');
            let totalCredits = 0; 

            entries.forEach(entry => {
                const inputs = entry.querySelectorAll('input');
                results.push({
                    course: inputs[0].value,
                    grade: inputs[1].value,
                    marks: parseInt(inputs[2].value)
                });
                totalCredits += 3; 
            });

            // 2. Add/Update Student Data in Firestore
            try {
                const docRef = db.collection("students").doc(sEmail);

                await docRef.set({
                    studentId: sID,
                    email: sEmail,
                    name: sName,
                    department: sDept,
                    cgpa: sCGPA,
                    totalCredits: totalCredits,
                    routine: sRoutine,
                    results: results 
                });

                messageDiv.textContent = `Student ${sName} (${sID}) data saved successfully! REMEMBER to manually create their account in Firebase Auth.`;
                messageDiv.classList.remove('hidden');
                
                // Optional: Clear form after successful submission
                // document.getElementById('addStudentForm').reset();
                // document.getElementById('results-container').innerHTML = '';
                // addResultField(); // Re-add one empty row

            } catch (error) {
                messageDiv.textContent = 'Error saving data: ' + error.message;
                messageDiv.classList.remove('hidden');
                console.error("Firestore Error:", error);
            }
        });

        // --- STUDENT PANEL LOGIC (Remains the same) ---

        async function fetchStudentData(studentEmail) {
            try {
                const docRef = db.collection("students").doc(studentEmail);
                const doc = await docRef.get();

                if (doc.exists) {
                    const data = doc.data();
                    showSection('student-section');

                    document.getElementById('student-name').textContent = data.name;
                    document.getElementById('s-dept').textContent = data.department;
                    document.getElementById('s-cgpa').textContent = data.cgpa.toFixed(2);
                    document.getElementById('s-credits').textContent = data.totalCredits;
                    document.getElementById('s-routine').textContent = data.routine || 'Routine not yet posted.';
                    
                    const tableBody = document.getElementById('results-table-body');
                    tableBody.innerHTML = ''; 
                    
                    data.results.forEach(result => {
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${result.course}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.grade}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.marks}</td>
                        `;
                    });

                } else {
                    showSection(null); 
                    alert("Your student data was not found. Please contact the administrator.");
                    logout();
                }

            } catch (error) {
                console.error("Error fetching student data:", error);
                alert("An error occurred while loading your data. Please try again.");
                logout();
            }
        }
    </script>
</body>
</html>